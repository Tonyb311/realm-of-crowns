// ============================================================
// Realm of Crowns - Prisma Schema
// PostgreSQL database schema for the Realm of Crowns MMORPG
// ============================================================

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================
// ENUMS
// ============================================================

enum Race {
  HUMAN
  ELF
  DWARF
  HARTHFOLK
  ORC
  NETHKIN
  DRAKONID
  HALF_ELF
  HALF_ORC
  GNOME
  MERFOLK
  BEASTFOLK
  FAEFOLK
  GOLIATH
  NIGHTBORNE
  MOSSKIN
  FORGEBORN
  ELEMENTARI
  REVENANT
  CHANGELING
}

enum RaceTier {
  CORE
  COMMON
  EXOTIC
}

enum DragonBloodline {
  RED
  BLUE
  WHITE
  BLACK
  GREEN
  GOLD
  SILVER
}

enum BeastClan {
  WOLF
  BEAR
  FOX
  HAWK
  PANTHER
  BOAR
}

enum ElementalType {
  FIRE
  WATER
  EARTH
  AIR
}

enum RelationStatus {
  ALLIED
  FRIENDLY
  NEUTRAL
  DISTRUSTFUL
  HOSTILE
  BLOOD_FEUD
}

enum ProfessionType {
  FARMER
  RANCHER
  FISHERMAN
  LUMBERJACK
  MINER
  HERBALIST
  HUNTER
  SMELTER
  BLACKSMITH
  ARMORER
  WOODWORKER
  TANNER
  LEATHERWORKER
  TAILOR
  ALCHEMIST
  ENCHANTER
  COOK
  BREWER
  JEWELER
  FLETCHER
  MASON
  SCRIBE
  MERCHANT
  INNKEEPER
  HEALER
  STABLE_MASTER
  BANKER
  COURIER
  MERCENARY_CAPTAIN
}

enum ProfessionCategory {
  GATHERING
  CRAFTING
  SERVICE
}

enum ProfessionTier {
  APPRENTICE
  JOURNEYMAN
  CRAFTSMAN
  EXPERT
  MASTER
  GRANDMASTER
}

enum BiomeType {
  PLAINS
  FOREST
  MOUNTAIN
  HILLS
  BADLANDS
  SWAMP
  TUNDRA
  VOLCANIC
  COASTAL
  DESERT
  RIVER
  UNDERGROUND
  UNDERWATER
  FEYWILD
}

enum ItemType {
  WEAPON
  ARMOR
  TOOL
  CONSUMABLE
  MATERIAL
  ACCESSORY
  QUEST
  HOUSING
}

enum ItemRarity {
  POOR
  COMMON
  FINE
  SUPERIOR
  MASTERWORK
  LEGENDARY
}

enum ResourceType {
  ORE
  WOOD
  GRAIN
  HERB
  FISH
  HIDE
  STONE
  FIBER
  ANIMAL_PRODUCT
  REAGENT
  EXOTIC
}

enum EquipSlot {
  HEAD
  CHEST
  HANDS
  LEGS
  FEET
  MAIN_HAND
  OFF_HAND
  RING_1
  RING_2
  NECK
  BACK
}

enum BuildingType {
  HOUSE_SMALL
  HOUSE_MEDIUM
  HOUSE_LARGE
  SMITHY
  SMELTERY
  TANNERY
  TAILOR_SHOP
  ALCHEMY_LAB
  ENCHANTING_TOWER
  KITCHEN
  BREWERY
  JEWELER_WORKSHOP
  FLETCHER_BENCH
  MASON_YARD
  LUMBER_MILL
  SCRIBE_STUDY
  STABLE
  WAREHOUSE
  BANK
  INN
  MARKET_STALL
  FARM
  RANCH
  MINE
}

enum ActionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  COLLECTED
  FAILED
  CANCELLED
}

enum CombatType {
  PVE
  PVP
  DUEL
  ARENA
  WAR
  SPAR
}

enum ElectionType {
  MAYOR
  RULER
  GUILD_LEADER
}

enum ElectionPhase {
  NOMINATIONS
  CAMPAIGNING
  VOTING
  COMPLETED
}

enum ImpeachmentStatus {
  ACTIVE
  PASSED
  FAILED
}

enum DiplomacyActionType {
  PROPOSE_TREATY
  DECLARE_WAR
  TRADE_AGREEMENT
  NON_AGGRESSION_PACT
  ALLIANCE
  BREAK_TREATY
}

enum QuestType {
  MAIN
  TOWN
  DAILY
  GUILD
  BOUNTY
  RACIAL
  TUTORIAL
}

enum FriendStatus {
  PENDING
  ACCEPTED
  DECLINED
  BLOCKED
}

enum MessageChannel {
  GLOBAL
  TOWN
  GUILD
  PARTY
  WHISPER
  TRADE
  SYSTEM
}

// NodeType enum removed — replaced by TravelNode.terrain + specialType strings

enum DailyActionType {
  GATHER
  CRAFT
  TRAVEL
  GUARD
  AMBUSH
  ENLIST
  PROPOSE_LAW
  REST
  SERVICE
  COMBAT_PVE
  COMBAT_PVP
  HARVEST
}

enum DailyActionStatus {
  LOCKED_IN
  PROCESSING
  COMPLETED
  FAILED
}

enum HungerState {
  FED
  HUNGRY
  STARVING
  INCAPACITATED
}

enum CombatStance {
  AGGRESSIVE
  BALANCED
  DEFENSIVE
  EVASIVE
}

enum FoodPriority {
  EXPIRING_FIRST
  BEST_FIRST
  SPECIFIC_ITEM
  CATEGORY_ONLY
}

enum LoanStatus {
  ACTIVE
  REPAID
  DEFAULTED
  GARNISHED
}

enum WarStatus {
  ACTIVE
  PEACE_PROPOSED
  ENDED
}

enum ElectionStatus {
  SCHEDULED
  ACTIVE
  COMPLETED
}

enum LawStatus {
  PROPOSED
  VOTING
  ACTIVE
  REJECTED
  EXPIRED
}

enum CombatSessionStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

// ============================================================
// MODELS
// ============================================================

// ---- Users & Characters ----

model User {
  id                String      @id @default(uuid())
  email             String      @unique
  username          String      @unique
  passwordHash      String      @map("password_hash")
  role              String      @default("player")
  isTestAccount     Boolean     @default(false) @map("is_test_account")
  activeCharacterId String?     @map("active_character_id")
  lastSwitchDay     Int?        @map("last_switch_day")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  characters        Character[]

  @@map("users")
}

model Character {
  id                     String           @id @default(uuid())
  userId                 String           @map("user_id")
  name                   String
  race                   Race
  raceTier               RaceTier         @default(CORE) @map("race_tier")
  dragonBloodline        DragonBloodline? @map("dragon_bloodline")
  beastClan              BeastClan?       @map("beast_clan")
  elementalType          ElementalType?   @map("elemental_type")
  subRace                Json?            @map("sub_race")
  unlockedAbilities      Json             @default("[]") @map("unlocked_abilities")
  currentAppearanceRace  Race?            @map("current_appearance_race")
  class                  String?
  specialization         String?
  level                  Int              @default(1)
  xp                     Int              @default(0)
  unspentStatPoints      Int              @default(0) @map("unspent_stat_points")
  unspentSkillPoints     Int              @default(0) @map("unspent_skill_points")
  title                  String?
  stats                  Json             @default("{}")
  currentTownId          String?          @map("current_town_id")
  homeTownId             String?          @map("home_town_id")
  health                 Int              @default(100)
  maxHealth              Int              @default(100) @map("max_health")
  gold                   Int              @default(0)
  escrowedGold           Int              @default(0) @map("escrowed_gold")
  // Combat presets
  retreatHpThreshold     Int              @default(25) @map("retreat_hp_threshold")
  retreatOppositionRatio Float            @default(3.0) @map("retreat_opposition_ratio")
  retreatRoundLimit      Int?             @map("retreat_round_limit")
  neverRetreat           Boolean          @default(false) @map("never_retreat")
  combatStance           CombatStance     @default(BALANCED) @map("combat_stance")
  abilityPriorityQueue   Json?            @map("ability_priority_queue")
  itemUsageRules         Json?            @map("item_usage_rules")
  pvpLootBehavior        String           @default("GOLD_ONLY") @map("pvp_loot_behavior")

  // Food & hunger
  hungerState          HungerState  @default(FED) @map("hunger_state")
  daysSinceLastMeal    Int          @default(0) @map("days_since_last_meal")
  foodPriority         FoodPriority @default(EXPIRING_FIRST) @map("food_priority")
  preferredFoodId      String?      @map("preferred_food_id")
  wellRested           Boolean      @default(false) @map("well_rested")
  soulFadeStage        Int          @default(0) @map("soul_fade_stage")
  structuralDecayStage Int          @default(0) @map("structural_decay_stage")

  // Travel status
  travelStatus String @default("idle") @map("travel_status") // idle, traveling_solo, traveling_group, arrived

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user          User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentTown   Town? @relation("CharacterCurrentTown", fields: [currentTownId], references: [id])
  homeTown      Town? @relation("CharacterHomeTown", fields: [homeTownId], references: [id])
  preferredFood Item? @relation("CharacterPreferredFood", fields: [preferredFoodId], references: [id], onDelete: SetNull)

  equipment               CharacterEquipment[]
  inventory               Inventory[]
  professions             PlayerProfession[]
  professionXp            ProfessionXP[]
  travelState             CharacterTravelState?
  travelGroupMemberships  TravelGroupMember[]
  ledTravelGroups         TravelGroup[]           @relation("TravelGroupLeader")
  craftingActions         CraftingAction[]
  gatheringActions        GatheringAction[]
  buildings               Building[]
  marketListings          MarketListing[]
  purchaseTransactions    TradeTransaction[]      @relation("Buyer")
  saleTransactions        TradeTransaction[]      @relation("Seller")
  caravans                Caravan[]
  electionVotes           ElectionVote[]
  guildMemberships        GuildMember[]
  questProgress           QuestProgress[]
  combatParticipations    CombatParticipant[]
  combatEncounterLogs     CombatEncounterLog[]
  sentMessages            Message[]               @relation("MessageSender")
  receivedMessages        Message[]               @relation("MessageRecipient")
  notifications           Notification[]
  racialCooldowns         RacialAbilityCooldown[]
  changelingDisguise      ChangelingDisguise?
  forgebornMaintenance    ForgebornMaintenance?
  appearances             CharacterAppearance[]
  playerAchievements      PlayerAchievement[]
  characterAbilities      CharacterAbility[]
  craftedItems            Item[]                  @relation("ItemCrafter")
  ownedItems              Item[]                  @relation("ItemOwner")
  mayorOfTowns            Town[]                  @relation("TownMayor")
  ruledKingdom            Kingdom?                @relation("KingdomRuler")
  ledGuild                Guild?                  @relation("GuildLeader")
  wonElections            Election[]              @relation("ElectionWinner")
  electionCandidacies     ElectionCandidate[]
  impeachmentsAgainst     Impeachment[]           @relation("ImpeachmentTarget")
  impeachmentVotes        ImpeachmentVote[]
  diplomacyInitiated      DiplomacyEvent[]        @relation("DiplomacyInitiator")
  diplomacyReceived       DiplomacyEvent[]        @relation("DiplomacyTarget")
  treatiesProposed        Treaty[]                @relation("TreatyProposedBy")
  enactedLaws             Law[]
  councilMemberships      CouncilMember[]         @relation("CouncilCharacter")
  appointedCouncilMembers CouncilMember[]         @relation("CouncilAppointer")
  sheriffOfTowns          TownPolicy[]            @relation("TownSheriff")
  friendRequestsSent      Friend[]                @relation("FriendRequester")
  friendRequestsReceived  Friend[]                @relation("FriendRecipient")
  petitionsCreated        Petition[]              @relation("PetitionCreator")
  petitionSignatures      PetitionSignature[]     @relation("PetitionSigner")
  dailyActions            DailyAction[]
  dailyReports            DailyReport[]
  servicesProvided        ServiceAction[]         @relation("ServiceProvider")
  servicesReceived        ServiceAction[]         @relation("ServiceClient")
  loansGiven              Loan[]                  @relation("LoanBanker")
  loansTaken              Loan[]                  @relation("LoanBorrower")
  serviceReputations      ServiceReputation[]
  lawVotes                LawVote[]
  partyMemberships        PartyMember[]
  ledParties              Party[]                 @relation("PartyLeader")
  partyInvitationsReceived PartyInvitation[]      @relation("PartyInvitee")
  partyInvitationsSent    PartyInvitation[]       @relation("PartyInviter")
  marketBuyOrders         MarketBuyOrder[]
  ownedAssets             OwnedAsset[]   @relation("OwnedAssets")
  jobListingsOwned        JobListing[]   @relation("JobListingsOwned")
  jobListingsWorking      JobListing[]   @relation("JobListingsWorking")

  @@index([userId])
  @@index([currentTownId])
  @@index([travelStatus])
  @@index([race])
  @@map("characters")
}

model CharacterEquipment {
  id          String    @id @default(uuid())
  characterId String    @map("character_id")
  slot        EquipSlot
  itemId      String    @map("item_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  item      Item      @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([characterId, slot])
  @@index([characterId])
  @@map("character_equipment")
}

model Inventory {
  id           String   @id @default(uuid())
  characterId  String   @map("character_id")
  itemId       String   @map("item_id")
  quantity     Int      @default(1)
  slotPosition Int?     @map("slot_position")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  item      Item      @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([characterId, itemId])
  @@index([characterId])
  @@map("inventories")
}

// ---- Professions ----
// Profession limit rules (enforced in application layer):
//   - Max 3 active professions total per character
//   - Max 2 GATHERING professions
//   - Max 2 CRAFTING professions
//   - Max 1 SERVICE profession

model PlayerProfession {
  id             String         @id @default(uuid())
  characterId    String         @map("character_id")
  professionType ProfessionType @map("profession_type")
  tier           ProfessionTier @default(APPRENTICE)
  level          Int            @default(1)
  xp             Int            @default(0)
  specialization String?
  isActive       Boolean        @default(true) @map("is_active")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, professionType])
  @@index([characterId])
  @@index([characterId, isActive])
  @@map("player_professions")
}

model ProfessionXP {
  id             String         @id @default(uuid())
  characterId    String         @map("character_id")
  professionType ProfessionType @map("profession_type")
  xpGained       Int            @map("xp_gained")
  source         String
  timestamp      DateTime       @default(now())

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId, professionType])
  @@map("profession_xp")
}

// ---- World Geography ----

model Region {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  biome       BiomeType
  levelMin    Int       @default(1) @map("level_min")
  levelMax    Int       @default(50) @map("level_max")
  kingdomId   String?   @map("kingdom_id") // P1 #16 / MAJOR-01: links region to governing kingdom
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  kingdom        Kingdom?        @relation("KingdomRegions", fields: [kingdomId], references: [id], onDelete: SetNull)
  towns          Town[]
  exclusiveZones ExclusiveZone[]
  quests         Quest[]
  monsters       Monster[]
  bordersA       RegionBorder[]  @relation("RegionBorderA")
  bordersB       RegionBorder[]  @relation("RegionBorderB")

  @@index([kingdomId])
  @@map("regions")
}

model Town {
  id          String    @id @default(uuid())
  name        String    @unique
  regionId    String    @map("region_id")
  population  Int       @default(0)
  biome       BiomeType
  description String?
  mayorId      String?   @map("mayor_id")
  features     Json      @default("[]")
  mapX         Float?    @map("map_x")
  mapY         Float?    @map("map_y")
  isReleased   Boolean   @default(false) @map("is_released")
  releasedAt   DateTime? @map("released_at")
  releaseOrder Int?      @map("release_order")
  releaseNotes String?   @map("release_notes")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  region Region     @relation(fields: [regionId], references: [id])
  mayor  Character? @relation("TownMayor", fields: [mayorId], references: [id], onDelete: SetNull)

  characters        Character[]        @relation("CharacterCurrentTown")
  homeCharacters    Character[]        @relation("CharacterHomeTown")
  resources         TownResource[]
  routesFrom        TravelRoute[]      @relation("RouteFrom")
  routesTo          TravelRoute[]      @relation("RouteTo")
  buildings         Building[]
  marketListings    MarketListing[]
  tradeTransactions TradeTransaction[]
  priceHistories    PriceHistory[]
  caravansFrom      Caravan[]          @relation("CaravanFrom")
  caravansTo        Caravan[]          @relation("CaravanTo")
  elections         Election[]
  impeachments      Impeachment[]      @relation("TownImpeachments")
  treasury          TownTreasury?
  gatheringActions  GatheringAction[]
  combatSessions      CombatSession[]
  combatEncounterLogs CombatEncounterLog[]
  encounterOrigins      CombatEncounterLog[] @relation("EncounterOrigin")
  encounterDestinations CombatEncounterLog[] @relation("EncounterDestination")
  messages            Message[]          @relation("TownMessages")
  townPolicy        TownPolicy?
  councilMembers    CouncilMember[]    @relation("TownCouncil")
  npcs              Npc[]
  parties           Party[]
  auctionCycles     AuctionCycle[]
  ownedAssets        OwnedAsset[] @relation("TownAssets")
  jobListings        JobListing[] @relation("TownJobs")

  @@index([regionId])
  @@index([mayorId])
  @@map("towns")
}

model TownResource {
  id           String       @id @default(uuid())
  townId       String       @map("town_id")
  resourceType ResourceType @map("resource_type")
  abundance    Int          @default(50)
  respawnRate  Float        @default(1.0) @map("respawn_rate")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  town Town @relation(fields: [townId], references: [id], onDelete: Cascade)

  @@unique([townId, resourceType])
  @@index([townId])
  @@map("town_resources")
}

model TravelRoute {
  id            String   @id @default(uuid())
  fromTownId    String   @map("from_town_id")
  toTownId      String   @map("to_town_id")
  name          String   @default("")
  description   String   @default("")
  nodeCount     Int      @default(3)  @map("node_count")
  dangerLevel   Int      @default(1)  @map("danger_level")
  difficulty    String   @default("moderate")
  terrain       String
  isReleased    Boolean  @default(false) @map("is_released")
  bidirectional Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  fromTown             Town                  @relation("RouteFrom", fields: [fromTownId], references: [id], onDelete: Cascade)
  toTown               Town                  @relation("RouteTo", fields: [toTownId], references: [id], onDelete: Cascade)
  travelNodes          TravelNode[]
  characterTravelStates CharacterTravelState[]
  groupTravelStates    GroupTravelState[]

  @@unique([fromTownId, toTownId])
  @@index([fromTownId])
  @@index([toTownId])
  @@index([isReleased])
  @@map("travel_routes")
}

// TravelAction removed — replaced by CharacterTravelState / GroupTravelState

model RegionBorder {
  id        String   @id @default(uuid())
  regionId1 String   @map("region_id_1")
  regionId2 String   @map("region_id_2")
  type      String   @default("land")
  createdAt DateTime @default(now()) @map("created_at")

  region1 Region @relation("RegionBorderA", fields: [regionId1], references: [id], onDelete: Cascade)
  region2 Region @relation("RegionBorderB", fields: [regionId2], references: [id], onDelete: Cascade)

  @@unique([regionId1, regionId2])
  @@map("region_borders")
}

// ---- Racial Relations & Diplomacy ----

model RacialRelation {
  id        String         @id @default(uuid())
  race1     Race
  race2     Race
  status    RelationStatus @default(NEUTRAL)
  modifier  Int            @default(0)
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  @@unique([race1, race2])
  @@map("racial_relations")
}

model DiplomacyEvent {
  id          String              @id @default(uuid())
  type        DiplomacyActionType
  initiatorId String              @map("initiator_id")
  targetId    String              @map("target_id")
  details     Json                @default("{}")
  timestamp   DateTime            @default(now())
  createdAt   DateTime            @default(now()) @map("created_at")

  initiator Character @relation("DiplomacyInitiator", fields: [initiatorId], references: [id])
  target    Character @relation("DiplomacyTarget", fields: [targetId], references: [id])

  @@index([initiatorId])
  @@index([targetId])
  @@map("diplomacy_events")
}

model War {
  id                String    @id @default(uuid())
  attackerKingdomId String    @map("attacker_kingdom_id")
  defenderKingdomId String    @map("defender_kingdom_id")
  reason            String?
  status            WarStatus @default(ACTIVE)
  attackerScore     Int       @default(0) @map("attacker_score")
  defenderScore     Int       @default(0) @map("defender_score")
  startedAt         DateTime  @default(now()) @map("started_at")
  endedAt           DateTime? @map("ended_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  attackerKingdom Kingdom @relation("WarAttacker", fields: [attackerKingdomId], references: [id])
  defenderKingdom Kingdom @relation("WarDefender", fields: [defenderKingdomId], references: [id])

  @@index([attackerKingdomId])
  @@index([defenderKingdomId])
  @@index([status])
  @@map("wars")
}

enum TreatyType {
  TRADE_AGREEMENT
  NON_AGGRESSION_PACT
  ALLIANCE
}

enum TreatyStatus {
  PENDING
  ACTIVE
  EXPIRED
  BROKEN
}

model Treaty {
  id                String       @id @default(uuid())
  type              TreatyType
  proposerKingdomId String       @map("proposer_kingdom_id")
  receiverKingdomId String       @map("receiver_kingdom_id")
  proposedById      String       @map("proposed_by_id")
  status            TreatyStatus @default(PENDING)
  goldCost          Int          @default(0) @map("gold_cost")
  requiredDays      Int          @default(0) @map("required_days")
  startsAt          DateTime?    @map("starts_at")
  expiresAt         DateTime?    @map("expires_at")
  metadata          Json         @default("{}")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  proposerKingdom Kingdom   @relation("TreatyProposer", fields: [proposerKingdomId], references: [id])
  receiverKingdom Kingdom   @relation("TreatyReceiver", fields: [receiverKingdomId], references: [id])
  proposedBy      Character @relation("TreatyProposedBy", fields: [proposedById], references: [id])

  @@index([proposerKingdomId])
  @@index([receiverKingdomId])
  @@index([status])
  @@map("treaties")
}

model ExclusiveZone {
  id                 String   @id @default(uuid())
  name               String
  description        String?
  requiredRaces      Json     @default("[]") @map("required_races")
  owningRace         Race?    @map("owning_race")
  requiredLevel      Int      @default(1) @map("required_level")
  entryRequirements  Json     @default("[]") @map("entry_requirements")
  availableResources Json     @default("[]") @map("available_resources")
  dangerLevel        Int      @default(1) @map("danger_level")
  specialMechanics   Json     @default("{}") @map("special_mechanics")
  zoneType           String   @default("exclusive") @map("zone_type")
  regionId           String   @map("region_id")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  region Region @relation(fields: [regionId], references: [id], onDelete: Cascade)

  @@index([regionId])
  @@map("exclusive_zones")
}

// ---- Items & Resources ----

model Resource {
  id             String       @id @default(uuid())
  name           String       @unique
  type           ResourceType
  biome          BiomeType
  tier           Int          @default(1)
  description    String?
  baseGatherTime Int          @default(60) @map("base_gather_time")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  gatheringActions GatheringAction[]

  @@index([type])
  @@index([biome])
  @@map("resources")
}

model ItemTemplate {
  id                 String          @id @default(uuid())
  name               String
  type               ItemType
  rarity             ItemRarity      @default(COMMON)
  description        String?
  stats              Json            @default("{}")
  durability         Int             @default(100)
  requirements       Json            @default("{}")
  professionRequired ProfessionType? @map("profession_required")
  levelRequired      Int             @default(1) @map("level_required")
  shelfLifeDays      Int?            @map("shelf_life_days")
  isFood             Boolean         @default(false) @map("is_food")
  foodBuff           Json?           @map("food_buff")
  isPerishable       Boolean         @default(false) @map("is_perishable")
  isBeverage         Boolean         @default(false) @map("is_beverage")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")

  items          Item[]
  priceHistories PriceHistory[]

  @@index([type])
  @@index([rarity])
  @@map("item_templates")
}

model Item {
  id                String     @id @default(uuid())
  templateId        String     @map("template_id")
  ownerId           String?    @map("owner_id")
  currentDurability Int        @default(100) @map("current_durability")
  quality           ItemRarity @default(COMMON)
  craftedById       String?    @map("crafted_by_id")
  enchantments      Json       @default("[]")
  daysRemaining     Int?       @map("days_remaining")
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")

  template  ItemTemplate @relation(fields: [templateId], references: [id])
  owner     Character?   @relation("ItemOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  craftedBy Character?   @relation("ItemCrafter", fields: [craftedById], references: [id], onDelete: SetNull)

  equipment             CharacterEquipment[]
  inventory             Inventory[]
  marketListings        MarketListing[]
  tradeTransactions     TradeTransaction[]
  preferredByCharacters Character[]          @relation("CharacterPreferredFood")

  @@index([templateId])
  @@index([ownerId])
  @@index([craftedById])
  @@map("items")
}

// ---- Crafting & Gathering ----

model Recipe {
  id             String         @id @default(uuid())
  name           String
  professionType ProfessionType @map("profession_type")
  tier           ProfessionTier
  ingredients    Json           @default("[]")
  result         String
  craftTime      Int            @default(60) @map("craft_time")
  xpReward       Int            @default(10) @map("xp_reward")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  craftingActions CraftingAction[]

  @@index([professionType])
  @@index([tier])
  @@map("recipes")
}

model CraftingAction {
  id          String       @id @default(uuid())
  characterId String       @map("character_id")
  recipeId    String       @map("recipe_id")
  status      ActionStatus @default(PENDING)
  quality     ItemRarity?
  tickDate    DateTime?    @map("tick_date")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  recipe    Recipe    @relation(fields: [recipeId], references: [id])

  @@index([characterId])
  @@index([status])
  @@map("crafting_actions")
}

model GatheringAction {
  id          String       @id @default(uuid())
  characterId String       @map("character_id")
  resourceId  String       @map("resource_id")
  townId      String       @map("town_id")
  status      ActionStatus @default(PENDING)
  quantity    Int          @default(1)
  tickDate    DateTime?    @map("tick_date")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  resource  Resource  @relation(fields: [resourceId], references: [id])
  town      Town      @relation(fields: [townId], references: [id])

  @@index([characterId])
  @@index([status])
  @@map("gathering_actions")
}

// ---- Buildings ----

model Building {
  id        String       @id @default(uuid())
  ownerId   String       @map("owner_id")
  townId    String       @map("town_id")
  type      BuildingType
  name      String
  level     Int          @default(1)
  storage   Json         @default("{}")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  owner Character @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  town  Town      @relation(fields: [townId], references: [id], onDelete: Cascade)

  constructions BuildingConstruction[]

  @@index([ownerId])
  @@index([townId])
  @@map("buildings")
}

model BuildingConstruction {
  id            String       @id @default(uuid())
  buildingId    String       @map("building_id")
  status        ActionStatus @default(PENDING)
  materialsUsed Json         @default("{}") @map("materials_used")
  startedAt     DateTime     @default(now()) @map("started_at")
  completesAt   DateTime?    @map("completes_at")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  @@index([buildingId])
  @@index([status])
  @@map("building_constructions")
}

// ---- Economy & Trade ----

model MarketListing {
  id             String    @id @default(uuid())
  sellerId       String    @map("seller_id")
  itemId         String    @map("item_id")
  itemTemplateId String    @default("") @map("item_template_id")
  itemName       String    @default("") @map("item_name")
  price          Int                        // askingPrice (minimum bid)
  quantity       Int       @default(1)
  townId         String    @map("town_id")
  status         String    @default("active")  // active|sold|cancelled|expired
  auctionCycleId String?   @map("auction_cycle_id")
  listedAt       DateTime  @default(now()) @map("listed_at")
  expiresAt      DateTime? @map("expires_at")
  soldAt         DateTime? @map("sold_at")
  soldTo         String?   @map("sold_to")
  soldPrice      Int?      @map("sold_price")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  seller    Character       @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  item      Item            @relation(fields: [itemId], references: [id], onDelete: Cascade)
  town      Town            @relation(fields: [townId], references: [id])
  cycle     AuctionCycle?   @relation(fields: [auctionCycleId], references: [id])
  buyOrders MarketBuyOrder[]

  @@index([sellerId])
  @@index([townId])
  @@index([itemId])
  @@index([townId, price])
  @@index([status, townId])
  @@map("market_listings")
}

model TradeTransaction {
  id             String   @id @default(uuid())
  buyerId        String   @map("buyer_id")
  sellerId       String   @map("seller_id")
  itemId         String   @map("item_id")
  price          Int
  quantity       Int      @default(1)
  townId         String   @map("town_id")
  sellerFee      Int      @default(0) @map("seller_fee")
  sellerNet      Int      @default(0) @map("seller_net")
  numBidders     Int      @default(1) @map("num_bidders")
  contested      Boolean  @default(false)
  allBidders     Json?    @map("all_bidders")   // JSONB: [{name, profession, bidPrice, priorityScore, rollResult, rollBreakdown, outcome}]
  auctionCycleId String?  @map("auction_cycle_id")
  timestamp      DateTime @default(now())
  createdAt      DateTime @default(now()) @map("created_at")

  buyer  Character     @relation("Buyer", fields: [buyerId], references: [id])
  seller Character     @relation("Seller", fields: [sellerId], references: [id])
  item   Item          @relation(fields: [itemId], references: [id])
  town   Town          @relation(fields: [townId], references: [id])
  cycle  AuctionCycle? @relation(fields: [auctionCycleId], references: [id])

  @@index([buyerId])
  @@index([sellerId])
  @@index([townId])
  @@index([timestamp])
  @@index([buyerId, createdAt]) // MAJOR-06: trade history lookups per buyer
  @@index([sellerId, createdAt]) // MAJOR-06: trade history lookups per seller
  @@index([auctionCycleId])
  @@map("trade_transactions")
}

model PriceHistory {
  id             String   @id @default(uuid())
  itemTemplateId String   @map("item_template_id")
  townId         String   @map("town_id")
  avgPrice       Float    @map("avg_price")
  volume         Int      @default(0)
  date           DateTime @db.Date
  createdAt      DateTime @default(now()) @map("created_at")

  itemTemplate ItemTemplate @relation(fields: [itemTemplateId], references: [id])
  town         Town         @relation(fields: [townId], references: [id])

  @@unique([itemTemplateId, townId, date])
  @@index([itemTemplateId])
  @@index([townId])
  @@map("price_histories")
}

model MarketBuyOrder {
  id             String    @id @default(uuid())
  buyerId        String    @map("buyer_id")
  listingId      String    @map("listing_id")
  bidPrice       Int       @map("bid_price")
  status         String    @default("pending")  // pending|won|lost|cancelled
  priorityScore  Float?    @map("priority_score")
  rollResult     Int?      @map("roll_result")
  rollBreakdown  Json?     @map("roll_breakdown")
  placedAt       DateTime  @default(now()) @map("placed_at")
  resolvedAt     DateTime? @map("resolved_at")
  auctionCycleId String?   @map("auction_cycle_id")

  buyer   Character     @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  listing MarketListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  cycle   AuctionCycle? @relation(fields: [auctionCycleId], references: [id])

  @@unique([buyerId, listingId])
  @@index([listingId])
  @@index([buyerId])
  @@index([status])
  @@map("market_buy_orders")
}

model AuctionCycle {
  id                    String    @id @default(uuid())
  townId                String    @map("town_id")
  cycleNumber           Int       @map("cycle_number")
  startedAt             DateTime  @default(now()) @map("started_at")
  resolvedAt            DateTime? @map("resolved_at")
  status                String    @default("open")  // open|processing|resolved
  ordersProcessed       Int       @default(0) @map("orders_processed")
  transactionsCompleted Int       @default(0) @map("transactions_completed")
  contestedListings     Int       @default(0) @map("contested_listings")
  merchantWins          Int       @default(0) @map("merchant_wins")
  nonMerchantWins       Int       @default(0) @map("non_merchant_wins")
  totalGoldTraded       Int       @default(0) @map("total_gold_traded")

  town         Town               @relation(fields: [townId], references: [id])
  listings     MarketListing[]
  orders       MarketBuyOrder[]
  transactions TradeTransaction[]

  @@index([townId, status])
  @@map("auction_cycles")
}

model Caravan {
  id         String       @id @default(uuid())
  ownerId    String       @map("owner_id")
  fromTownId String       @map("from_town_id")
  toTownId   String       @map("to_town_id")
  cargo      Json         @default("[]")
  status     ActionStatus @default(PENDING)
  departedAt DateTime?    @map("departed_at")
  arrivesAt  DateTime?    @map("arrives_at")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  owner    Character @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  fromTown Town      @relation("CaravanFrom", fields: [fromTownId], references: [id])
  toTown   Town      @relation("CaravanTo", fields: [toTownId], references: [id])

  @@index([ownerId])
  @@index([status])
  @@map("caravans")
}

// ---- Politics ----

model Election {
  id         String         @id @default(uuid())
  townId     String         @map("town_id")
  kingdomId  String?        @map("kingdom_id")
  type       ElectionType
  status     ElectionStatus @default(SCHEDULED)
  phase      ElectionPhase  @default(NOMINATIONS)
  termNumber Int            @default(1) @map("term_number")
  startDate  DateTime       @map("start_date")
  endDate    DateTime       @map("end_date")
  winnerId   String?        @map("winner_id")
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")

  town       Town                @relation(fields: [townId], references: [id], onDelete: Cascade)
  kingdom    Kingdom?            @relation("KingdomElections", fields: [kingdomId], references: [id], onDelete: SetNull)
  winner     Character?          @relation("ElectionWinner", fields: [winnerId], references: [id], onDelete: SetNull)
  votes      ElectionVote[]
  candidates ElectionCandidate[]

  @@index([townId])
  @@index([kingdomId])
  @@index([status])
  @@map("elections")
}

model ElectionVote {
  id          String   @id @default(uuid())
  electionId  String   @map("election_id")
  voterId     String   @map("voter_id")
  candidateId String   @map("candidate_id")
  createdAt   DateTime @default(now()) @map("created_at")

  election Election  @relation(fields: [electionId], references: [id], onDelete: Cascade)
  voter    Character @relation(fields: [voterId], references: [id], onDelete: Cascade)

  @@unique([electionId, voterId])
  @@index([electionId])
  @@map("election_votes")
}

model ElectionCandidate {
  id          String   @id @default(uuid())
  electionId  String   @map("election_id")
  characterId String   @map("character_id")
  platform    String   @default("")
  nominatedAt DateTime @default(now()) @map("nominated_at")
  createdAt   DateTime @default(now()) @map("created_at")

  election  Election  @relation(fields: [electionId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([electionId, characterId])
  @@index([electionId])
  @@index([characterId])
  @@map("election_candidates")
}

model Impeachment {
  id           String            @id @default(uuid())
  targetId     String            @map("target_id")
  townId       String?           @map("town_id")
  kingdomId    String?           @map("kingdom_id")
  votesFor     Int               @default(0) @map("votes_for")
  votesAgainst Int               @default(0) @map("votes_against")
  status       ImpeachmentStatus @default(ACTIVE)
  startedAt    DateTime          @default(now()) @map("started_at")
  endsAt       DateTime          @map("ends_at")
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  target  Character         @relation("ImpeachmentTarget", fields: [targetId], references: [id], onDelete: Cascade)
  town    Town?             @relation("TownImpeachments", fields: [townId], references: [id], onDelete: SetNull)
  kingdom Kingdom?          @relation("KingdomImpeachments", fields: [kingdomId], references: [id], onDelete: SetNull)
  votes   ImpeachmentVote[]

  @@index([targetId])
  @@index([townId])
  @@index([kingdomId])
  @@index([status])
  @@map("impeachments")
}

model ImpeachmentVote {
  id            String   @id @default(uuid())
  impeachmentId String   @map("impeachment_id")
  voterId       String   @map("voter_id")
  support       Boolean
  createdAt     DateTime @default(now()) @map("created_at")

  impeachment Impeachment @relation(fields: [impeachmentId], references: [id], onDelete: Cascade)
  voter       Character   @relation(fields: [voterId], references: [id], onDelete: Cascade)

  @@unique([impeachmentId, voterId])
  @@index([impeachmentId])
  @@map("impeachment_votes")
}

model TownTreasury {
  id              String   @id @default(uuid())
  townId          String   @unique @map("town_id")
  balance         Int      @default(0)
  taxRate         Float    @default(0.10) @map("tax_rate")
  lastCollectedAt DateTime @default(now()) @map("last_collected_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  town Town @relation(fields: [townId], references: [id], onDelete: Cascade)

  @@map("town_treasuries")
}

model Law {
  id           String    @id @default(uuid())
  kingdomId    String    @map("kingdom_id")
  title        String
  description  String?
  effects      Json      @default("{}")
  enactedById  String    @map("enacted_by_id")
  enactedAt    DateTime  @default(now()) @map("enacted_at")
  status       LawStatus @default(PROPOSED)
  votesFor     Int       @default(0) @map("votes_for")
  votesAgainst Int       @default(0) @map("votes_against")
  proposedAt   DateTime  @default(now()) @map("proposed_at")
  expiresAt    DateTime? @map("expires_at")
  lawType      String    @default("general") @map("law_type")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  kingdom   Kingdom   @relation(fields: [kingdomId], references: [id], onDelete: Cascade)
  enactedBy Character @relation(fields: [enactedById], references: [id])
  lawVotes  LawVote[]

  @@index([kingdomId])
  @@index([status])
  @@map("laws")
}

model LawVote {
  id          String    @id @default(uuid())
  lawId       String    @map("law_id")
  characterId String    @map("character_id")
  vote        String // 'FOR' or 'AGAINST'
  createdAt   DateTime  @default(now()) @map("created_at")
  law         Law       @relation(fields: [lawId], references: [id])
  character   Character @relation(fields: [characterId], references: [id])

  @@unique([lawId, characterId])
  @@map("law_votes")
}

model Kingdom {
  id            String   @id @default(uuid())
  name          String   @unique
  rulerId       String?  @unique @map("ruler_id")
  capitalTownId String?  @unique @map("capital_town_id")
  treasury      Int      @default(0)
  laws          Json     @default("[]")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  ruler            Character?      @relation("KingdomRuler", fields: [rulerId], references: [id], onDelete: SetNull)
  regions          Region[]        @relation("KingdomRegions") // P1 #16 / MAJOR-01: territories belonging to this kingdom
  elections        Election[]      @relation("KingdomElections")
  impeachments     Impeachment[]   @relation("KingdomImpeachments")
  lawRecords       Law[]
  warsAttacking    War[]           @relation("WarAttacker")
  warsDefending    War[]           @relation("WarDefender")
  councilMembers   CouncilMember[] @relation("KingdomCouncil")
  treatiesProposed Treaty[]        @relation("TreatyProposer")
  treatiesReceived Treaty[]        @relation("TreatyReceiver")

  @@map("kingdoms")
}

// ---- Guilds ----

model Guild {
  id          String   @id @default(uuid())
  name        String   @unique
  tag         String   @unique
  leaderId    String?  @unique @map("leader_id")
  level       Int      @default(1)
  treasury    Int      @default(0)
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  leader   Character?    @relation("GuildLeader", fields: [leaderId], references: [id], onDelete: SetNull)
  members  GuildMember[]
  messages Message[]     @relation("GuildMessages")

  @@map("guilds")
}

model GuildMember {
  id          String   @id @default(uuid())
  guildId     String   @map("guild_id")
  characterId String   @map("character_id")
  rank        String   @default("member")
  joinedAt    DateTime @default(now()) @map("joined_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  guild     Guild     @relation(fields: [guildId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([guildId, characterId])
  @@index([guildId])
  @@index([characterId])
  @@map("guild_members")
}

// ---- NPCs ----

enum NpcRole {
  QUEST_GIVER
  MERCHANT
  TRAINER
  GUARD
}

model Npc {
  id        String   @id @default(uuid())
  name      String
  townId    String   @map("town_id")
  role      NpcRole  @default(QUEST_GIVER)
  dialog    Json     @default("{}")
  questIds  String[] @map("quest_ids")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  town Town @relation(fields: [townId], references: [id], onDelete: Cascade)

  @@index([townId])
  @@index([role])
  @@map("npcs")
}

// ---- Quests ----

model Quest {
  id                  String    @id @default(uuid())
  name                String
  slug                String?   @unique
  type                QuestType
  description         String?
  objectives          Json      @default("[]")
  rewards             Json      @default("{}")
  levelRequired       Int       @default(1) @map("level_required")
  sortOrder           Int       @default(0) @map("sort_order")
  isActive            Boolean   @default(true) @map("is_active")
  regionId            String?   @map("region_id")
  prerequisiteQuestId String?   @map("prerequisite_quest_id")
  isRepeatable        Boolean   @default(false) @map("is_repeatable")
  cooldownHours       Int?      @map("cooldown_hours")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  region            Region?         @relation(fields: [regionId], references: [id], onDelete: SetNull)
  prerequisiteQuest Quest?          @relation("QuestPrerequisite", fields: [prerequisiteQuestId], references: [id], onDelete: SetNull)
  dependentQuests   Quest[]         @relation("QuestPrerequisite")
  progress          QuestProgress[]

  @@index([type])
  @@index([regionId])
  @@index([prerequisiteQuestId])
  @@map("quests")
}

model QuestProgress {
  id          String       @id @default(uuid())
  characterId String       @map("character_id")
  questId     String       @map("quest_id")
  status      ActionStatus @default(PENDING)
  progress    Json         @default("{}")
  startedAt   DateTime     @default(now()) @map("started_at")
  completedAt DateTime?    @map("completed_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  quest     Quest     @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@unique([characterId, questId])
  @@index([characterId])
  @@index([questId])
  @@index([characterId, status])
  @@map("quest_progress")
}

// ---- Combat ----

model CombatSession {
  id             String              @id @default(uuid())
  type           CombatType
  status         CombatSessionStatus @default(ACTIVE)
  locationTownId String?             @map("location_town_id")
  startedAt      DateTime            @default(now()) @map("started_at")
  endedAt        DateTime?           @map("ended_at")
  log            Json                @default("[]")
  attackerParams Json?               @map("attacker_params")
  defenderParams Json?               @map("defender_params")
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")

  locationTown Town?               @relation(fields: [locationTownId], references: [id], onDelete: SetNull)
  combatLogs   CombatLog[]
  participants CombatParticipant[]

  @@index([status])
  @@index([locationTownId])
  @@map("combat_sessions")
}

model CombatLog {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  round     Int
  actorId   String   @map("actor_id")
  action    String
  result    Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")

  session CombatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sessionId, round])
  @@index([actorId]) // MAJOR-06: index for combat history lookups per character
  @@map("combat_logs")
}

model CombatParticipant {
  id          String   @id @default(uuid())
  sessionId   String   @map("session_id")
  characterId String   @map("character_id")
  team        Int      @default(0)
  initiative  Int      @default(0)
  currentHp   Int      @default(100) @map("current_hp")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  session   CombatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  character Character     @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([sessionId, characterId])
  @@index([sessionId])
  @@index([characterId])
  @@map("combat_participants")
}

model CombatEncounterLog {
  id               String   @id @default(uuid())
  type             String   // 'pve' | 'pvp'
  sessionId        String?  @map("session_id")
  characterId      String   @map("character_id")
  characterName    String   @default("") @map("character_name")
  opponentId       String?  @map("opponent_id")
  opponentName     String   @default("") @map("opponent_name")
  townId           String?  @map("town_id")
  partyId          String?  @map("party_id")
  startedAt        DateTime @default(now()) @map("started_at")
  endedAt          DateTime @default(now()) @map("ended_at")
  outcome          String   @default("") // 'win' | 'loss' | 'flee' | 'draw'
  totalRounds      Int      @default(0) @map("total_rounds")
  characterStartHp Int      @default(0) @map("character_start_hp")
  characterEndHp   Int      @default(0) @map("character_end_hp")
  opponentStartHp  Int      @default(0) @map("opponent_start_hp")
  opponentEndHp    Int      @default(0) @map("opponent_end_hp")
  characterWeapon  String   @default("") @map("character_weapon")
  opponentWeapon   String   @default("") @map("opponent_weapon")
  xpAwarded        Int      @default(0) @map("xp_awarded")
  goldAwarded      Int      @default(0) @map("gold_awarded")
  lootDropped      String   @default("") @map("loot_dropped")
  rounds           Json     @default("[]")
  summary          String   @default("")
  triggerSource    String   @default("town_pve") @map("trigger_source") // 'road_encounter' | 'group_road_encounter' | 'town_pve' | 'pvp_duel' | 'pvp_spar' | 'arena'
  originTownId     String?  @map("origin_town_id")
  destinationTownId String? @map("destination_town_id")
  simulationTick   Int?     @map("simulation_tick")
  createdAt        DateTime @default(now()) @map("created_at")

  character       Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  town            Town?     @relation(fields: [townId], references: [id], onDelete: SetNull)
  party           Party?    @relation(fields: [partyId], references: [id], onDelete: SetNull)
  originTown      Town?     @relation("EncounterOrigin", fields: [originTownId], references: [id], onDelete: SetNull)
  destinationTown Town?     @relation("EncounterDestination", fields: [destinationTownId], references: [id], onDelete: SetNull)

  @@index([characterId, startedAt])
  @@index([simulationTick])
  @@index([type])
  @@index([triggerSource])
  @@index([partyId])
  @@map("combat_encounter_logs")
}

model Monster {
  id        String    @id @default(uuid())
  name      String
  level     Int       @default(1)
  stats     Json      @default("{}")
  lootTable Json      @default("[]") @map("loot_table")
  regionId  String?   @map("region_id")
  biome     BiomeType
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  region Region? @relation(fields: [regionId], references: [id], onDelete: SetNull)

  @@index([regionId])
  @@index([level])
  @@map("monsters")
}

// ---- Communication ----

model Message {
  id          String         @id @default(uuid())
  channelType MessageChannel @map("channel_type")
  content     String
  senderId    String         @map("sender_id")
  recipientId String?        @map("recipient_id")
  guildId     String?        @map("guild_id")
  townId      String?        @map("town_id")
  isRead      Boolean        @default(false) @map("is_read")
  timestamp   DateTime       @default(now())
  createdAt   DateTime       @default(now()) @map("created_at")

  sender    Character  @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient Character? @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: SetNull)
  guild     Guild?     @relation("GuildMessages", fields: [guildId], references: [id], onDelete: SetNull)
  town      Town?      @relation("TownMessages", fields: [townId], references: [id], onDelete: SetNull)

  @@index([senderId])
  @@index([recipientId])
  @@index([guildId])
  @@index([townId])
  @@index([channelType, townId, timestamp])
  @@map("messages")
}

model Notification {
  id          String   @id @default(uuid())
  characterId String   @map("character_id")
  type        String
  title       String
  message     String
  read        Boolean  @default(false)
  data        Json     @default("{}")
  timestamp   DateTime @default(now())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([characterId, read])
  @@index([characterId, read, createdAt]) // MAJOR-06: efficient "unread notifications, newest first" queries
  @@map("notifications")
}

// ---- Race-Specific Mechanics ----

model RacialAbilityCooldown {
  id           String   @id @default(uuid())
  characterId  String   @map("character_id")
  abilityName  String   @map("ability_name")
  lastUsed     DateTime @map("last_used")
  cooldownEnds DateTime @map("cooldown_ends")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, abilityName])
  @@index([characterId])
  @@map("racial_ability_cooldowns")
}

model ChangelingDisguise {
  id           String   @id @default(uuid())
  characterId  String   @unique @map("character_id")
  disguisedAs  String?  @map("disguised_as")
  disguiseRace Race?    @map("disguise_race")
  startedAt    DateTime @default(now()) @map("started_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("changeling_disguises")
}

model ForgebornMaintenance {
  id              String   @id @default(uuid())
  characterId     String   @unique @map("character_id")
  lastMaintenance DateTime @map("last_maintenance")
  condition       Int      @default(100)
  nextRequired    DateTime @map("next_required")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("forgeborn_maintenance")
}

model CharacterAppearance {
  id           String   @id @default(uuid())
  characterId  String   @map("character_id")
  apparentRace Race     @map("apparent_race")
  apparentName String?  @map("apparent_name")
  features     Json     @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@map("character_appearances")
}

// ---- Achievements ----

model Achievement {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  criteria    Json     @default("{}")
  reward      Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  players PlayerAchievement[]

  @@map("achievements")
}

model PlayerAchievement {
  id            String   @id @default(uuid())
  characterId   String   @map("character_id")
  achievementId String   @map("achievement_id")
  unlockedAt    DateTime @default(now()) @map("unlocked_at")
  createdAt     DateTime @default(now()) @map("created_at")

  character   Character   @relation(fields: [characterId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([characterId, achievementId])
  @@index([characterId])
  @@map("player_achievements")
}

// ---- Governance ----

model CouncilMember {
  id            String   @id @default(uuid())
  kingdomId     String?  @map("kingdom_id")
  townId        String?  @map("town_id")
  characterId   String   @map("character_id")
  role          String
  appointedAt   DateTime @default(now()) @map("appointed_at")
  appointedById String   @map("appointed_by_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  kingdom     Kingdom?  @relation("KingdomCouncil", fields: [kingdomId], references: [id], onDelete: Cascade)
  town        Town?     @relation("TownCouncil", fields: [townId], references: [id], onDelete: Cascade)
  character   Character @relation("CouncilCharacter", fields: [characterId], references: [id], onDelete: Cascade)
  appointedBy Character @relation("CouncilAppointer", fields: [appointedById], references: [id])

  @@index([kingdomId])
  @@index([townId])
  @@index([characterId])
  @@map("council_members")
}

model TownPolicy {
  id              String   @id @default(uuid())
  townId          String   @unique @map("town_id")
  taxRate         Float    @default(0.10) @map("tax_rate")
  tradePolicy     Json     @default("{}") @map("trade_policy")
  buildingPermits Boolean  @default(true) @map("building_permits")
  sheriffId       String?  @map("sheriff_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  town    Town       @relation(fields: [townId], references: [id], onDelete: Cascade)
  sheriff Character? @relation("TownSheriff", fields: [sheriffId], references: [id], onDelete: SetNull)

  @@map("town_policies")
}

// ---- Friends ----

model Friend {
  id          String       @id @default(uuid())
  requesterId String       @map("requester_id")
  recipientId String       @map("recipient_id")
  status      FriendStatus @default(PENDING)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  requester Character @relation("FriendRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  recipient Character @relation("FriendRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([requesterId, recipientId])
  @@index([requesterId])
  @@index([recipientId])
  @@index([status])
  @@index([requesterId, status])
  @@index([recipientId, status])
  @@map("friends")
}

// ---- Abilities & Skill Trees ----

model Ability {
  id                    String   @id @default(uuid())
  name                  String   @unique
  description           String?
  class                 String
  specialization        String
  tier                  Int      @default(1)
  effects               Json     @default("{}")
  cooldown              Int      @default(0)
  prerequisiteAbilityId String?  @map("prerequisite_ability_id")
  levelRequired         Int      @default(1) @map("level_required")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  prerequisite       Ability?           @relation("AbilityPrereq", fields: [prerequisiteAbilityId], references: [id])
  dependents         Ability[]          @relation("AbilityPrereq")
  characterAbilities CharacterAbility[]

  @@index([class])
  @@index([class, specialization])
  @@map("abilities")
}

model CharacterAbility {
  id          String   @id @default(uuid())
  characterId String   @map("character_id")
  abilityId   String   @map("ability_id")
  unlockedAt  DateTime @default(now()) @map("unlocked_at")
  createdAt   DateTime @default(now()) @map("created_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  ability   Ability   @relation(fields: [abilityId], references: [id], onDelete: Cascade)

  @@unique([characterId, abilityId])
  @@index([characterId])
  @@map("character_abilities")
}

// ---- World Events & Petitions ----

enum PetitionStatus {
  ACTIVE
  FULFILLED
  EXPIRED
  REJECTED
}

model WorldEvent {
  id          String   @id @default(uuid())
  eventType   String   @map("event_type")
  title       String
  description String
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([eventType])
  @@index([createdAt])
  @@map("world_events")
}

model Petition {
  id            String         @id @default(uuid())
  creatorId     String         @map("creator_id")
  petitionType  String         @map("petition_type")
  title         String
  description   String
  targetData    Json           @default("{}") @map("target_data")
  status        PetitionStatus @default(ACTIVE)
  signatureGoal Int            @default(10) @map("signature_goal")
  expiresAt     DateTime       @map("expires_at")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  creator    Character           @relation("PetitionCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  signatures PetitionSignature[]

  @@index([creatorId])
  @@index([status])
  @@index([expiresAt])
  @@map("petitions")
}

model PetitionSignature {
  id          String   @id @default(uuid())
  petitionId  String   @map("petition_id")
  characterId String   @map("character_id")
  createdAt   DateTime @default(now()) @map("created_at")

  petition  Petition  @relation(fields: [petitionId], references: [id], onDelete: Cascade)
  character Character @relation("PetitionSigner", fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([petitionId, characterId])
  @@index([petitionId])
  @@index([characterId])
  @@map("petition_signatures")
}

// ---- Travel System (tick-based node routes) ----

model TravelNode {
  id          String   @id @default(uuid())
  routeId     String   @map("route_id")
  nodeIndex   Int      @map("node_index")
  name        String
  description String
  terrain     String
  dangerLevel Int      @default(3) @map("danger_level") // 1-10
  specialType String?  @map("special_type") // crossroads, bridge, ruins, camp, shrine, cave, ford, watchtower
  offsetX     Float    @default(0) @map("offset_x") // curve offset from straight line interpolation
  offsetY     Float    @default(0) @map("offset_y")
  createdAt   DateTime @default(now()) @map("created_at")

  route TravelRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@unique([routeId, nodeIndex])
  @@index([routeId])
  @@map("travel_nodes")
}

// ---- Party System ----

model Party {
  id          String    @id @default(uuid())
  name        String?
  leaderId    String    @map("leader_id")
  townId      String    @map("town_id")
  status      String    @default("active") // active, disbanded
  maxSize     Int       @default(5) @map("max_size")
  createdAt   DateTime  @default(now()) @map("created_at")
  disbandedAt DateTime? @map("disbanded_at")

  leader      Character           @relation("PartyLeader", fields: [leaderId], references: [id])
  town        Town                @relation(fields: [townId], references: [id])
  members     PartyMember[]
  invitations PartyInvitation[]
  travelGroups TravelGroup[]
  combatEncounterLogs CombatEncounterLog[]

  @@index([leaderId])
  @@index([townId])
  @@index([status])
  @@map("parties")
}

model PartyMember {
  id          String    @id @default(uuid())
  partyId     String    @map("party_id")
  characterId String    @map("character_id")
  role        String    @default("member") // leader, member
  joinedAt    DateTime  @default(now()) @map("joined_at")
  leftAt      DateTime? @map("left_at")

  party     Party     @relation(fields: [partyId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([partyId])
  @@index([characterId])
  @@index([characterId, leftAt])
  @@map("party_members")
}

model PartyInvitation {
  id          String   @id @default(uuid())
  partyId     String   @map("party_id")
  characterId String   @map("character_id")
  invitedById String   @map("invited_by_id")
  status      String   @default("pending") // pending, accepted, declined, expired
  createdAt   DateTime @default(now()) @map("created_at")
  expiresAt   DateTime @map("expires_at")

  party     Party     @relation(fields: [partyId], references: [id], onDelete: Cascade)
  character Character @relation("PartyInvitee", fields: [characterId], references: [id], onDelete: Cascade)
  invitedBy Character @relation("PartyInviter", fields: [invitedById], references: [id], onDelete: Cascade)

  @@index([partyId])
  @@index([characterId, status])
  @@map("party_invitations")
}

model TravelGroup {
  id        String   @id @default(uuid())
  leaderId  String   @map("leader_id")
  name      String?
  status    String   @default("forming") // forming, traveling, arrived, disbanded
  maxSize   Int      @default(5)  @map("max_size")
  partyId   String?  @map("party_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  leader      Character           @relation("TravelGroupLeader", fields: [leaderId], references: [id])
  party       Party?              @relation(fields: [partyId], references: [id], onDelete: SetNull)
  members     TravelGroupMember[]
  travelState GroupTravelState?

  @@index([leaderId])
  @@index([status])
  @@index([partyId])
  @@map("travel_groups")
}

model TravelGroupMember {
  id          String   @id @default(uuid())
  groupId     String   @map("group_id")
  characterId String   @map("character_id")
  role        String   @default("member") // leader, member
  joinedAt    DateTime @default(now()) @map("joined_at")

  group     TravelGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  character Character   @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([groupId, characterId])
  @@index([characterId])
  @@map("travel_group_members")
}

model CharacterTravelState {
  id               String    @id @default(uuid())
  characterId      String    @unique @map("character_id")
  routeId          String    @map("route_id")
  currentNodeIndex Int       @map("current_node_index") // 0=departed, nodeCount+1=arrived
  direction        String    @default("forward") // forward, backward
  speedModifier    Int       @default(1) @map("speed_modifier")
  startedAt        DateTime  @default(now()) @map("started_at")
  lastTickAt       DateTime? @map("last_tick_at")
  status           String    @default("traveling") // traveling, arrived, blocked

  character Character   @relation(fields: [characterId], references: [id], onDelete: Cascade)
  route     TravelRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([routeId, currentNodeIndex])
  @@map("character_travel_states")
}

model GroupTravelState {
  id               String    @id @default(uuid())
  groupId          String    @unique @map("group_id")
  routeId          String    @map("route_id")
  currentNodeIndex Int       @map("current_node_index")
  direction        String    @default("forward")
  speedModifier    Int       @default(1) @map("speed_modifier")
  startedAt        DateTime  @default(now()) @map("started_at")
  lastTickAt       DateTime? @map("last_tick_at")
  status           String    @default("traveling")

  group TravelGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  route TravelRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("group_travel_states")
}

// ---- Daily Tick System ----

model DailyAction {
  id           String            @id @default(uuid())
  characterId  String            @map("character_id")
  tickDate     DateTime          @map("tick_date")
  actionType   DailyActionType   @map("action_type")
  actionTarget Json              @map("action_target")
  combatParams Json?             @map("combat_params")
  status       DailyActionStatus @default(LOCKED_IN)
  result       Json?
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, tickDate])
  @@index([characterId])
  @@index([tickDate])
  @@index([status])
  @@map("daily_actions")
}

model DailyReport {
  id            String   @id @default(uuid())
  characterId   String   @map("character_id")
  tickDate      DateTime @map("tick_date")
  foodConsumed  Json?    @map("food_consumed")
  actionResult  Json?    @map("action_result")
  goldChange    Int      @default(0) @map("gold_change")
  xpEarned      Int      @default(0) @map("xp_earned")
  combatLogs    Json?    @map("combat_logs")
  questProgress Json?    @map("quest_progress")
  notifications Json?
  worldEvents   Json?    @map("world_events")
  createdAt     DateTime @default(now()) @map("created_at")

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, tickDate])
  @@index([characterId])
  @@index([tickDate])
  @@map("daily_reports")
}

// ---- Service Professions ----

model ServiceAction {
  id             String         @id @default(uuid())
  providerId     String         @map("provider_id")
  provider       Character      @relation("ServiceProvider", fields: [providerId], references: [id], onDelete: Cascade) // MAJOR-08: cascade on character delete
  clientId       String?        @map("client_id")
  client         Character?     @relation("ServiceClient", fields: [clientId], references: [id], onDelete: SetNull) // MAJOR-08: nullify on client delete
  professionType ProfessionType @map("profession_type")
  actionType     String         @map("action_type")
  price          Int            @default(0)
  details        Json?
  gameDay        Int            @map("game_day")
  createdAt      DateTime       @default(now()) @map("created_at")

  @@index([providerId])
  @@index([clientId])
  @@index([gameDay])
  @@map("service_actions")
}

model Loan {
  id           String     @id @default(uuid())
  bankerId     String     @map("banker_id")
  banker       Character  @relation("LoanBanker", fields: [bankerId], references: [id], onDelete: Cascade) // MAJOR-08: cascade on character delete
  borrowerId   String     @map("borrower_id")
  borrower     Character  @relation("LoanBorrower", fields: [borrowerId], references: [id], onDelete: Cascade) // MAJOR-08: cascade on character delete
  principal    Int
  interestRate Float      @map("interest_rate")
  totalOwed    Int        @map("total_owed")
  amountRepaid Int        @default(0) @map("amount_repaid")
  termDays     Int        @map("term_days")
  startDay     Int        @map("start_day")
  dueDay       Int        @map("due_day")
  status       LoanStatus @default(ACTIVE)
  createdAt    DateTime   @default(now()) @map("created_at")

  @@index([bankerId])
  @@index([borrowerId])
  @@map("loans")
}

model ServiceReputation {
  id             String         @id @default(uuid())
  characterId    String         @map("character_id")
  character      Character      @relation(fields: [characterId], references: [id], onDelete: Cascade) // MAJOR-09: cascade on character delete
  professionType ProfessionType @map("profession_type")
  reputation     Int            @default(0)
  lastActiveDay  Int            @map("last_active_day")

  @@unique([characterId, professionType])
  @@map("service_reputations")
}

// ---- Error Logging ----

enum LogLevel {
  ERROR
  WARN
  INFO
  DEBUG
}

model ErrorLog {
  id          String    @id @default(uuid())
  timestamp   DateTime  @default(now())
  level       LogLevel  @default(ERROR)
  category    String    @default("general")
  endpoint    String
  statusCode  Int       @map("status_code")
  message     String
  detail      String?
  userId      String?   @map("user_id")
  characterId String?   @map("character_id")
  requestBody Json?     @map("request_body")
  userAgent   String?   @map("user_agent")
  ip          String?
  resolved    Boolean   @default(false)
  resolvedBy  String?   @map("resolved_by")
  resolvedAt  DateTime? @map("resolved_at")
  notes       String?

  @@index([timestamp])
  @@index([level])
  @@index([category])
  @@index([statusCode])
  @@index([resolved])
  @@index([userId])
  @@map("error_logs")
}

// ---- Content Release Gating ----

model ContentRelease {
  id          String    @id @default(uuid())
  contentType String    @map("content_type")
  contentId   String    @map("content_id")
  contentName String    @map("content_name")
  tier        String?
  isReleased  Boolean   @default(false) @map("is_released")
  releasedAt  DateTime? @map("released_at")
  releaseOrder Int?     @map("release_order")
  releaseNotes String?  @map("release_notes")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@unique([contentType, contentId])
  @@index([contentType])
  @@index([isReleased])
  @@map("content_releases")
}

// ---- Private Asset Ownership ----

model OwnedAsset {
  id             String   @id @default(uuid())
  ownerId        String   @map("owner_id")
  townId         String   @map("town_id")
  professionType String   @map("profession_type")
  spotType       String   @map("spot_type")
  tier           Int      @default(1)
  slotNumber     Int      @map("slot_number")
  name           String
  cropState      String   @default("EMPTY") @map("crop_state")
  plantedAt      Int?     @map("planted_at")
  readyAt        Int?     @map("ready_at")
  witheringAt    Int?     @map("withering_at")
  purchasePrice  Int      @map("purchase_price")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  owner      Character  @relation("OwnedAssets", fields: [ownerId], references: [id], onDelete: Cascade)
  town       Town       @relation("TownAssets", fields: [townId], references: [id], onDelete: Cascade)
  jobListing JobListing?

  @@unique([ownerId, professionType, tier, slotNumber])
  @@index([ownerId])
  @@index([townId])
  @@index([cropState])
  @@map("owned_assets")
}

model JobListing {
  id        String   @id @default(uuid())
  assetId   String   @unique @map("asset_id")
  ownerId   String   @map("owner_id")
  townId    String   @map("town_id")
  wage      Int
  workerId  String?  @map("worker_id")
  isOpen    Boolean  @default(true) @map("is_open")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  asset  OwnedAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  owner  Character  @relation("JobListingsOwned", fields: [ownerId], references: [id], onDelete: Cascade)
  worker Character? @relation("JobListingsWorking", fields: [workerId], references: [id], onDelete: SetNull)
  town   Town       @relation("TownJobs", fields: [townId], references: [id], onDelete: Cascade)

  @@index([townId, isOpen])
  @@index([ownerId])
  @@index([workerId])
  @@map("job_listings")
}
